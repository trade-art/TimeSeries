name: Build RedisTimeSeries Module (Windows)

on:
  workflow_dispatch:
    inputs:
      timeseries_version:
        description: "RedisTimeSeries git tag (e.g. v7.99.91)"
        required: true
        default: "v7.99.91"

jobs:
  build:
    runs-on: windows-latest

    defaults:
      run:
        shell: msys2 {0}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup MSYS2 (MINGW64)
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            autoconf
            automake
            libtool
            m4
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-make
            make
            mingw-w64-x86_64-pkg-config
            mingw-w64-x86_64-openssl
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-python
            mingw-w64-x86_64-python-pip
            git
            tar
            curl
            p7zip

      - name: Ensure python3 + pip commands exist
        run: |
          set -euo pipefail
          if ! command -v python3 >/dev/null 2>&1; then
            if command -v python >/dev/null 2>&1; then
              cat > /mingw64/bin/python3 <<'EOF'
          #!/usr/bin/env bash
          exec python "$@"
          EOF
              chmod +x /mingw64/bin/python3
            fi
          fi
          python3 --version
          python3 -m pip --version

      - name: Download RedisTimeSeries source
        run: |
          set -euo pipefail
          echo "Cloning redistimeseries ${{ inputs.timeseries_version }}"
          git clone --recursive --depth 1 --branch "${{ inputs.timeseries_version }}" https://github.com/redistimeseries/redistimeseries.git redistimeseries-src

      - name: Patch readies for Windows (python + Werror)
        working-directory: redistimeseries-src
        run: |
          set -euo pipefail

          # Fix readies platform detection on Windows: os.version() does not exist in Python.
          PAELLA_PLATFORM="deps/readies/paella/platform.py"
          if [ -f "$PAELLA_PLATFORM" ]; then
            sed -i 's/self\.os_full_ver = os\.version()/self.os_full_ver = platform.version()/' "$PAELLA_PLATFORM" || true
          fi

          # Configure libevent to avoid building samples/regress on Windows (they fail to compile under MinGW).
          LIBEVENT_MK="build/libevent/Makefile"
          if [ -f "$LIBEVENT_MK" ]; then
          python - <<'PY'
from pathlib import Path

path = Path("build/libevent/Makefile")
text = path.read_text(encoding="utf-8", errors="ignore")
flag_line = "CONFIGURE_FLAGS.windows += --disable-samples --disable-libevent-regress --disable-openssl\n"
marker = "include $(MK)/defs\n"

if "--disable-samples" not in text:
    if marker not in text:
        raise SystemExit("ERROR: cannot find 'include $(MK)/defs' in build/libevent/Makefile")
    text = text.replace(marker, flag_line + marker, 1)
    path.write_text(text, encoding="utf-8")
PY
          fi

          # Drop readies -Werror flags that break dependency builds on Windows/MinGW.
          CC_DEFS="deps/readies/mk/cc.defs"
          if [ -f "$CC_DEFS" ]; then
            sed -i '/-Werror=incompatible-pointer-types/d' "$CC_DEFS"
            sed -i '/-Werror=implicit-function-declaration/d' "$CC_DEFS"
          fi

      - name: Build RedisTimeSeries module
        working-directory: redistimeseries-src
        run: |
          set -euo pipefail
          JOBS="$(python -c 'import os; print(os.cpu_count() or 1)')"
          MAKE_BIN=make
          command -v "$MAKE_BIN" >/dev/null 2>&1 || MAKE_BIN=mingw32-make

          # readies/bin/getpy3 uses MYPY when present; enforce a working interpreter with pip.
          export MYPY=python
          "$MAKE_BIN" DISABLE_WERRORS=1 -j"$JOBS"

      - name: Package artifact
        run: |
          set -euo pipefail
          DIST="dist/RedisTimeSeries-${{ inputs.timeseries_version }}-Windows-x64"
          mkdir -p "$DIST"

          TS_MOD="$(cd redistimeseries-src && find bin -maxdepth 6 -type f \( -name 'redistimeseries*.so' -o -name 'redistimeseries*.dll' \) | head -n 1)"
          if [ -z "$TS_MOD" ]; then
            echo "ERROR: module binary not found under redistimeseries-src/bin"
            exit 1
          fi

          # Provide both extensions for convenience.
          cp "$TS_MOD" "$DIST/redistimeseries.so"
          cp "$TS_MOD" "$DIST/redistimeseries.dll"

          # Copy common runtime DLLs (ignore if missing).
          cp /mingw64/bin/libgcc_s_seh-1.dll "$DIST/" || true
          cp /mingw64/bin/libstdc++-6.dll "$DIST/" || true
          cp /mingw64/bin/libwinpthread-1.dll "$DIST/" || true
          cp /mingw64/bin/libcrypto-3-x64.dll "$DIST/" || true
          cp /mingw64/bin/libssl-3-x64.dll "$DIST/" || true

          (cd dist && 7z a -tzip "RedisTimeSeries-${{ inputs.timeseries_version }}-Windows-x64.zip" "RedisTimeSeries-${{ inputs.timeseries_version }}-Windows-x64")

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: redistimeseries-windows
          path: dist/*.zip
          retention-days: 14
